<!-- templates/order.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Order Panel</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h2>Place Order</h2>
    <p>Welcome, {{ session.username }}</p>
    <a href="{{ url_for('logout') }}">Logout</a>

    <form id="lookup-form">
      <input type="text" id="uid" placeholder="Enter 4-digit UID" required>
      <button type="submit">Lookup</button>
    </form>

    <form id="order-form" method="POST" action="{{ url_for('submit_order') }}" style="display:none;">
      <select name="customer_id" id="customer-select" required></select>

      <select name="drink_name" required>
        {% for drink in drinks %}
          <option value="{{ drink['name'] }}">{{ drink['name'] }}</option>
        {% endfor %}
      </select>

      <input type="number" name="quantity" placeholder="Quantity" required min="1">
      <label><input type="checkbox" name="redeem"> Redeem Tokens</label>
      <button type="submit">Submit</button>
    </form>

    <div id="customer-summary" style="display:none;">
      <h3>Customer Summary</h3>
      <p id="summary-content"></p>
    </div>
  </div>

  <script>
    $('#lookup-form').submit(function(e) {
      e.preventDefault();
      const uid = $('#uid').val();
      $.get(`/get_customers_by_uid?uid=${uid}`, function(data) {
        if (data.length > 0) {
          $('#customer-select').empty();
          data.forEach(c => {
            $('#customer-select').append(`<option value="${c.id}">${c.name}</option>`);
          });
          $('#order-form').show();
          loadSummary(data[0].id);
        } else {
          alert("No customers found.");
        }
      });
    });

    $('#customer-select').change(function() {
      const id = $(this).val();
      loadSummary(id);
    });

    function loadSummary(customerId) {
      $.get(`/get_customer_summary/${customerId}`, function(summary) {
        const html = `
          Name: ${summary.name}<br>
          Total Orders: ${summary.total_orders}<br>
          Tokens Earned: ${summary.tokens_earned}<br>
          Tokens Redeemed: ${summary.tokens_redeemed}<br>
          Token Balance: ${summary.token_balance}
        `;
        $('#summary-content').html(html);
        $('#customer-summary').show();
      });
    }
  </script>
</body>
</html>
